---
title: "Case Studies: Replicate Tables and Figures"
---

Summary: Code to replicate figures and tables in "Berkeley Unified Numident Mortality Database: Public Administrative Records for Individual-Level Mortality Research" section 

To replicate, move a copy of the BUNMD V2 file into the top-level "data" directory. 

## Setup 

Library packages and source functions 

```{r}
## Library packages 
library(tidyverse)
library(data.table)
library(memisc)
library(here)
library(HMDHFDplus)
library(gridExtra)
library(ggpubr)
library(cowplot)
library(gt)
library(fixest)
library(stargazer)
library(choroplethrZip)
library(choroplethr)
library(sf)``
library(broom)
library(lubridate)
library(gompertztrunc)

## source functions 
source(here("code/helper_functions.R"))

## Read in BUNMD file
bunmd <- fread(here("data/bunmd_v2.csv"))
```

```{r}
#####################################################################
## An example comparing foreign born and native longevity Using BUNMD
##################################################################### 

## filter to complete cases
bunmd <- bunmd %>% 
    filter(!is.na(ccweight)) %>% 
    as.data.table()

## set countries 
countries <- c("Canada", "Mexico", "Cuba", "Jamaica", "England", "Ireland", "Greece", "Italy", "Portugal", "Austria", "Philippines", "Japan", "Syria", "Czechoslovakia", "Germany", "Poland", "Yugoslavia", "Russia", "China", "USA")

## restrict to top countries 
bunmd <- bunmd %>% 
  mutate(bpl_string = case_when(
    bpl < 1300  ~ "USA",
    bpl %in% 45300:45362 ~ "Germany",
    TRUE ~ bpl_string
  )) %>% 
  filter(bpl_string %in% countries)
```


```{r}
## Filter to birth cohorts and years of analysis 
bunmd_analysis <- bunmd %>% 
  filter(byear %in% 1910:1919 &
          dyear %in% 1988:2005 &
          age_first_application < 65) 

## Set reference groups for model
bunmd_analysis <- bunmd_analysis %>% 
  mutate(byear = relevel(as.factor(byear), ref = "1910"),
         country = relevel(as.factor(bpl_string), ref = "USA"))

## Restrict to men 
bunmd_analysis_men <- bunmd_analysis %>% 
  filter(sex == 1)

## Run Gompertz model 
gompertz_results <- gompertz_mle(death_age ~ country, data = bunmd_analysis_men,
                                 left_trunc = 1988, right_trunc = 2005, 
                                 weights = ccweight)

## Convert hazards to life expectancy 
gompertz_results_men <- convert_hazards_to_ex(gompertz_results$results, use_model_estimates = T)

## Plot gompertz results for men 
gompertz_results_men_plot <- gompertz_results_men %>% 
  mutate(parameter = socviz::prefix_strip(parameter, prefixes = "country")) %>% 
  ggplot(aes(y = reorder(parameter, e65), x = e65, xmin = e65_lower, xmax = e65_upper)) + 
  geom_pointrange() + 
  theme_cowplot() + 
    geom_vline(xintercept  = 0, linetype = "dashed") + 
  labs(x = "e65 difference",
       y = "", 
      title =" Foreign−born men, cohorts 1910−19") + 
  annotate("text", x = 0.1, y = 16, label = "Natives", color = "black", angle = 270) + 
  xlim(-1, 3) 


## Compare to linear regression 
gompertz_estimates <- gompertz_results_men %>% 
  mutate(parameter = socviz::prefix_strip(parameter, prefixes = "country")) %>% 
    mutate(estimate = "Gompertz")

## Linear models 
lm_results_men <- lm(death_age ~ country + as.factor(byear), weights = ccweight, data = bunmd_analysis_men)

## linear models for men 
lm_results_men <- lm_results_men %>% 
  tidy() %>% 
  filter(term != "(Intercept)") %>% 
  mutate(parameter = socviz::prefix_strip(term, prefixes = "country"),
         e65 = estimate,
         e65_lower = estimate - 2*std.error,
         e65_upper = estimate + 2*std.error) %>% 
  mutate(estimate = "Regression on Age of Death") %>% 
  filter(!str_detect(parameter, "year")) %>% 
  filter(parameter %in% gompertz_estimates$parameter)

gompertz_estimates %>% 
  bind_rows(lm_estimates) %>% 
 ggplot(aes(y = parameter, x = e65, xmin = e65_lower,
            xmax = e65_upper, color = estimate)) + 
  geom_pointrange(position = position_dodge(width = 0.3)) + 
  theme_cowplot() + 
  theme(legend.position = "bottom") +
  ggsci::scale_color_lancet() 
```


```{r}
## Restrict to men 
bunmd_analysis_women <- bunmd_analysis %>% 
  filter(sex == 2)

## Run with ccweight 
gompertz_results_women <- gompertz_mle(death_age ~ country, data = bunmd_analysis_women,
                                 left_trunc = 1988, right_trunc = 2005, 
                                 weights = bunmd_analysis_women$ccweight)
## Convert hazards to e65 
gompertz_results_women_e65 <- convert_hazards_to_ex(gompertz_results_women$results, use_model_estimates = T) %>% 
    mutate(estimate = "Gompertz")

## Plot gompertz results for men 
gompertz_results_women_plot <- gompertz_results_women_e65 %>% 
  mutate(parameter = socviz::prefix_strip(parameter, prefixes = "country")) %>% 
  ggplot(aes(y = reorder(parameter, e65), x = e65, xmin = e65_lower, xmax = e65_upper)) + 
  geom_pointrange() + 
  theme_cowplot() + 
  geom_vline(xintercept  = 0, linetype = "dashed") + 
  labs(x = "e65 difference",
       y = "",
       title =" Foreign−born women, cohorts 1910−19") + 
  annotate("text", x = 0.1, y = 16, label = "Natives", color = "black", angle = 270) + 
  xlim(-1, 3) 

## Female immigrants   
bunmd_analysis_women_lm <- lm(death_age ~ country + as.factor(byear), data = bunmd_analysis_women)

## Linear model estimates women (30 min) 
lm_estimates_women <- bunmd_analysis_women_lm %>% 
  tidy() %>% 
  filter(term != "(Intercept)") %>% 
  mutate(parameter = socviz::prefix_strip(term, prefixes = "country"),
         e65 = estimate,
         e65_lower = estimate - 2*std.error,
         e65_upper = estimate + 2*std.error) %>% 
  mutate(estimate = "Regression on Age of Death") %>% 
  filter(!str_detect(parameter, "year")) %>% 
  filter(parameter %in% gompertz_estimates$parameter)

## Plots  
gompertz_results_women_e65 %>% 
  bind_rows(lm_estimates_women) %>% 
  mutate(parameter = socviz::prefix_strip(parameter, prefixes = "country")) %>% 
 ggplot(aes(y = parameter, x = e65, xmin = e65_lower,
            xmax = e65_upper, color = estimate)) + 
  geom_pointrange(position = position_dodge(width = 0.3)) + 
  theme_cowplot() + 
  theme(legend.position = "bottom") +
  labs(x = "estimate",
       y = "")  + 
  xlim(-2, 4) + 
  ggsci::scale_color_lancet() 
```


```{r}
## combine plots 
gompertz_immigrant_plot <- cowplot::plot_grid(gompertz_results_women_plot, gompertz_results_men_plot, nrow = 2, labels = "auto") 

## save plots 
ggsave(plot = gompertz_immigrant_plot, filename = here("figs/immigrant_plot.pdf"), 
       width = 10, height = 10,
       device = cairo_pdf)
```


## Cuyahoga County Example 

```{r}
## create 5-digit ZIP codes
bunmd[,"zip5" := as.numeric(substr(zip_residence, 1, 5))]

## Find cuyahoga county ZIP Codes
data("zip.regions")

## Filter to only include ZIP Codes in Cuyahoga
cuyahoga.zip <- zip.regions %>%
  filter(county.name == "cuyahoga")

## filter to only include cuyahoga ZIP Codes
cuyahoga.df <- bunmd %>% 
  filter(zip5 %in% cuyahoga.zip$region) %>% 
  as.data.table()

## restrict to high coverage years
cuyahoga.df.filter <- cuyahoga.df[byear %in% 1910:1919 &
                                    dyear %in% 1988:2005 &
                                    age_first_application < 65]

## prepare variables for regression
cuyahoga.df.filter[, byear := as.factor(byear)]
cuyahoga.df.filter[, byear := relevel(byear, ref = "1910")]

## prepare variables for regression
cuyahoga.df.filter[, zip5 := as.factor(zip5)]
cuyahoga.df.filter[, zip5 := relevel(zip5, ref = "44101")]

## gompertz model 
cuyahoga.model_gompertz <- gompertztrunc::gompertz_mle(death_age ~ zip5 + as.factor(sex), right_trunc = 2005, left_trunc = 1988,
                     data = cuyahoga.df.filter,
                     weights = ccweight)

gompertz_cuyahoga <- gompertztrunc::convert_hazards_to_ex(cuyahoga.model_gompertz$results)

gompertz_cuyahoga <- gompertz_cuyahoga %>% 
  mutate(region = substr(parameter, 5, 9)) %>% 
  mutate(value = e65) %>% 
  mutate(value = round(value, 1))

## Create choro plot
ohio_fips <-  39035
choro = ZipChoropleth$new(rev(gompertz_cuyahoga))
choro$title = ""
choro$set_zoom_zip(state_zoom = NULL, county_zoom = ohio_fips, msa_zoom = NULL, zip_zoom = NULL)

## Add on a boundary for cleveland. We will pull this from the Tigris database. 

## Shapefile must be downloaded from 
shapefile <- st_read("/90days/caseybreen/City_of_Cleveland_Neighborhoods_2012_no_lake/City_of_Cleveland_Neighborhoods_2012_no_lake.shp") 

scale_colour_manual(values = c("d73027", "fc8d59", "fee090", "ffffbf", "e0f3f8", "91bfdb", "4575b4"))

## Plot Cleveland
cleveland_plot <- choro$render() +
  theme(text=element_text(size=25)) + 
   # viridis::scale_fill_viridis(discrete = "true", direction = 1, name = "Difference in e65") +     
  scale_colour_manual(
    values = c("#d73027", "#fc8d59", "#fee090", "#ffffbf", "#e0f3f8", "#91bfdb", "#4575b4"),
    aesthetics = c("colour", "fill"),
    name = "Difference in e65"
  ) + 
  geom_sf(data = st_union(shapefile),
       inherit.aes = FALSE, fill = NA, size = 1.2, color = "Black") +
  annotate("label", x=-81.67908, y=41.48074, label="Cleveland", color = "Black", size = 8)

ggsave(plot = cleveland_plot, filename = here("figs/cleveland_plot.pdf"), width = 12, height = 8)
```

## Cuyahoga county ZIP benefits 

Average SS retirement benefits per retiree. 

```{r}
## read in social security benefit level
## total benefits from 2005. 

oasdi <- fread(here("data/oasdi_zip05_combined_new.csv"))

oasdi_small <- oasdi[, .(zip, zip_ben)]
oasdi_small[, .N, by = zip]

## merge data
bunmd[, zip5 := as.numeric(substr(zip_residence, 1, 5))]
bunmd <- merge(bunmd, oasdi_small[!is.na(zip)], by.x = "zip5", by.y = "zip", all.x = T)
```

```{r}
## filter to only include cuyahoga ZIP Codes
cuyahoga.df <- bunmd %>% 
  filter(zip5 %in% cuyahoga.zip$region) %>% 
  as.data.table()

## 
zipben_cuyahoga <- cuyahoga.df %>% 
  group_by(zip5) %>% 
  summarize(zip_ben = round(1000*mean(zip_ben))) %>% 
  dplyr::select(region = zip5, value = zip_ben) %>% 
  distinct() %>% 
  mutate(region = as.character(region))

ohio_fips <-  39035
choro = ZipChoropleth$new(rev(zipben_cuyahoga))
choro$title = ""
choro$set_zoom_zip(state_zoom = NULL, county_zoom = ohio_fips, msa_zoom = NULL, zip_zoom = NULL)

## Plot Cleveland
cleveland_plot_zipben <- choro$render() +
  theme(text=element_text(size=25)) + 
   # viridis::scale_fill_viridis(discrete = "true", direction = 1, name = "Avg. SS Benefits") + #  
  scale_colour_manual(
    values = c("#d73027", "#fc8d59", "#fee090", "#ffffbf", "#e0f3f8", "#91bfdb", "#4575b4"),
    aesthetics = c("colour", "fill"),
    name = "Avg. SS Benefits"
  ) + 
  geom_sf(data = st_union(shapefile),
       inherit.aes = FALSE, fill = NA, size = 1.2, color = "Black") +
  annotate("label", x=-81.67908, y=41.48074, label="Cleveland", color = "Black", size = 8) 

cleveland_plot_combined <- cowplot::plot_grid(cleveland_plot, cleveland_plot_zipben, nrow = 2, labels = "auto", label_size = 26)

ggsave(plot = cleveland_plot_combined, filename = here("figs/cleveland_plot_combined.pdf"), width = 14, height = 18)
```



