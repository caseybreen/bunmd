---
title: "Case Studies: Replicate Tables and Figures"
---

Summary: Code to replicate figures and tables in "Berkeley Unified Numident Mortality Database: Public Administrative Records for Individual-Level Mortality Research" section 

To replicate, move a copy of the BUNMD V2 file into the top-level "data" directory. 

## Setup 

Library packages and source functions 

```{r}
## Library packages 
library(tidyverse)
library(data.table)
library(memisc)
library(here)
library(HMDHFDplus)
library(gridExtra)
library(ggpubr)
library(cowplot)
library(gt)
library(fixest)
library(stargazer)
library(choroplethrZip)
library(choroplethr)
library(sf)
library(broom)
library(lubridate)
library(gompertztrunc)

## source functions 
source(here("code/helper_functions.R"))

## Read in BUNMD file
bunmd <- fread(here("data/bunmd_v2.csv"))
```

```{r}
#####################################################################
## An example comparing foreign born and native longevity Using BUNMD
##################################################################### 

## 1) read in "complete" sample
## 2) create analysis variables
## 3) example 1: 1 cohort only
## 4) example 2: a bunch of cohorts
## 5) example 3: cubans by race
## 6) note on regression coefficients

dt <- bunmd %>% 
    filter(!is.na(ccweight)) %>% 
    as.data.table()

## set countries 
countries <- c("Canada", "Mexico", "Cuba", "Jamaica", "England", "Ireland", "Greece", "Italy", "Portugal", "Austria", "Philippines", "Japan", "Syria", "Czechoslovakia", "Germany", "Poland", "Yugoslavia", "Russia", "China", "USA")


dt <- dt %>% 
  mutate(bpl_string = case_when(
    bpl < 1300  ~ "USA",
    bpl %in% 45300:45362 ~ "Germany",
    TRUE ~ bpl_string
  )) %>% 
  filter(bpl_string %in% countries)

countries <- dt %>%
  count(bpl_string) %>% 
  arrange(desc(n)) %>% 
  top_n(11) %>% 
  pull(bpl_string) 
```


```{r}
## Set reference groups for regression
dt <- dt %>% 
  mutate(byear = relevel(as.factor(byear), ref = "1910"),
         country = relevel(as.factor(bpl_string), ref = "USA"))

## filter to cohorts of interest and high death coverage window 
my.dt.2 <- dt[byear %in% 1910:1919 &
            dyear %in% 1988:2005 &
            age_first_application < 65]

my.dt.2_men <- my.dt.2 %>% 
  filter(sex == 1)

gompertz_results <- gompertz_mle(death_age ~ country, data = my.dt.2_men,
                                 left_trunc = 1988, right_trunc = 2005, 
                                 weights = my.dt.2_men$ccweight)

gompertz_results_men <- convert_hazards_to_e65(gompertz_results$results)

gompertz_results_men_plot <- gompertz_results_men %>% 
  mutate(parameter = socviz::prefix_strip(parameter, prefixes = "country")) %>% 
  ggplot(aes(y = reorder(parameter, e65), x = e65, xmin = e65_lower, xmax = e65_upper)) + 
  geom_pointrange() + 
  theme_cowplot() + 
  labs(x = "e65 difference",
       y = "") 

gompertz_estimates <- gompertz_results_men %>% 
  mutate(parameter = socviz::prefix_strip(parameter, prefixes = "country")) %>% 
    mutate(estimate = "Gompertz")

m.immig.male.2 <- lm(death_age ~ country + as.factor(byear), data = my.dt.2_men)

lm_estimates <- m.immig.male.2 %>% 
  tidy() %>% 
  filter(term != "(Intercept)") %>% 
  mutate(parameter = socviz::prefix_strip(term, prefixes = "country"),
         e65 = estimate,
         e65_lower = estimate - 2*std.error,
         e65_upper = estimate + 2*std.error) %>% 
  mutate(estimate = "Regression on Age of Death") %>% 
  filter(!str_detect(parameter, "year")) %>% 
  filter(parameter %in% gompertz_estimates$parameter)

gompertz_estimates %>% 
  bind_rows(lm_estimates) %>% 
 ggplot(aes(y = reorder(parameter, e65), x = e65, xmin = e65_lower,
            xmax = e65_upper, color = estimate)) + 
  geom_pointrange() + 
  theme_cowplot() + 
  theme(legend.position = "bottom") +
  ggsci::scale_color_lancet() 
```


```{r}
## filter to women 
my.dt.2_women <- my.dt.2 %>% 
  filter(sex == 2)

## run with ccweight 
gompertz_results_women <- gompertz_mle(death_age ~ country, data = my.dt.2_women,
                                 left_trunc = 1988, right_trunc = 2005, 
                                 weights = my.dt.2_women$ccweight)
## convert hazards to e65 
gompertz_results_women <- convert_hazards_to_e65(gompertz_results_women$results)

## plots 
gompertz_results_women_plot <- gompertz_results_women %>% 
  mutate(parameter = socviz::prefix_strip(parameter, prefixes = "country")) %>% 
  ggplot(aes(y = reorder(parameter, e65), x = e65, xmin = e65_lower, xmax = e65_upper)) + 
  geom_pointrange() + 
  theme_cowplot() + 
  labs(x = "e65 difference")
```



## Cuyahoga County Example 

```{r}
## create 5-digit ZIP codes
bunmd[,"zip5" := as.numeric(substr(zip_residence, 1, 5))]

## Find cuyahoga county ZIP Codes
data("zip.regions")

## Filter to only include ZIP Codes in Cuyahoga
cuyahoga.zip <- zip.regions %>%
  filter(county.name == "cuyahoga")

## filter to only include cuyahoga ZIP Codes
cuyahoga.df <- bunmd %>% 
  filter(zip5 %in% cuyahoga.zip$region) %>% 
  as.data.table()

## restrict to high coverage years
cuyahoga.df.filter <- cuyahoga.df[byear %in% 1910:1919 &
                                    dyear %in% 1988:2005 &
                                    age_first_application < 65 & 
                                    sex == 2]

## prepare variables for regression
cuyahoga.df.filter[, Byear := as.factor(byear)]
cuyahoga.df.filter[, Byear := relevel(Byear, ref = "1910")]

## prepare variables for regression
cuyahoga.df.filter[, Zip5 := as.factor(zip5)]
cuyahoga.df.filter[, Zip5 := relevel(Zip5, ref = "44101")]

## gompertz model 
cuyahoga.model_gompertz <- gompertztrunc::gompertz_mle(death_age ~ Zip5 , right_trunc = 2005, left_trunc = 1988,
                     data = cuyahoga.df.filter,
                     weights = ccweight)

gompertz_cuyahoga <- gompertztrunc::convert_hazards_to_e65(cuyahoga.model_gompertz$results)

gompertz_cuyahoga <- gompertz_cuyahoga %>% 
  mutate(region = substr(parameter, 5, 9)) %>% 
  mutate(value = e65) %>% 
  mutate(value = round(value, 1))

## Create choro plot
ohio_fips <-  39035
choro = ZipChoropleth$new(rev(gompertz_cuyahoga))
choro$title = ""
choro$set_zoom_zip(state_zoom = NULL, county_zoom = ohio_fips, msa_zoom = NULL, zip_zoom = NULL)

## Add on a boundary for cleveland. We will pull this from the Tigris database. 

## Shapefile must be downloaded from 
shapefile <- st_read("/90days/caseybreen/City_of_Cleveland_Neighborhoods_2012_no_lake/City_of_Cleveland_Neighborhoods_2012_no_lake.shp") 

## Plot Cleveland
cleveland_plot <- choro$render() +
  theme(text=element_text(size=25)) + 
   viridis::scale_fill_viridis(discrete = "true", direction = 1, name = "Difference in e65") + #  scale_fill_brewer(name="E65", palette = "Greens", direction = 1, na.value="grey", drop=FALSE) +
  geom_sf(data = st_union(shapefile),
       inherit.aes = FALSE, fill = NA, size = 1, color = "Red3") +
  annotate("label", x=-81.67908, y=41.48074, label="Cleveland", color = "Black", size = 8)

ggsave(plot = cleveland_plot, filename = here("figs/cleveland_plot.pdf"), width = 12, height = 8)
```

## Cuyahoga county ZIP benefits 

average SS retirement benefits per retiree. 

```{r}
## read in social security benefit level
## total benefits from 2005. 

oasdi <- fread(here("data/oasdi_zip05_combined_new.csv"))

oasdi_small <- oasdi[, .(zip, zip_ben)]
oasdi_small[, .N, by = zip]

## merge data
bunmd[, zip5 := as.numeric(substr(zip_residence, 1, 5))]
bunmd <- merge(bunmd, oasdi_small[!is.na(zip)], by.x = "zip5", by.y = "zip", all.x = T)
```

```{r}
## filter to only include cuyahoga ZIP Codes
cuyahoga.df <- bunmd %>% 
  filter(zip5 %in% cuyahoga.zip$region) %>% 
  as.data.table()

## 
zipben_cuyahoga <- cuyahoga.df %>% 
  group_by(zip5) %>% 
  summarize(zip_ben = mean(zip_ben)) %>% 
  dplyr::select(region = zip5, value = zip_ben) %>% 
  distinct() %>% 
  mutate(region = as.character(region))

ohio_fips <-  39035
choro = ZipChoropleth$new(rev(zipben_cuyahoga))
choro$title = ""
choro$set_zoom_zip(state_zoom = NULL, county_zoom = ohio_fips, msa_zoom = NULL, zip_zoom = NULL)

## Plot Cleveland
cleveland_plot_zipben <- choro$render() +
  theme(text=element_text(size=25)) + 
   viridis::scale_fill_viridis(discrete = "true", direction = 1, name = "Zip Retirement Benefits") + #  scale_fill_brewer(name="E65", palette = "Greens", direction = 1, na.value="grey", drop=FALSE) +
  geom_sf(data = st_union(shapefile),
       inherit.aes = FALSE, fill = NA, size = 1, color = "Red3") +
  annotate("label", x=-81.67908, y=41.48074, label="Cleveland", color = "Black", size = 8)

cleveland_plot_combined <- cowplot::plot_grid(cleveland_plot, cleveland_plot_zipben, nrow = 2)

ggsave(plot = cleveland_plot_combined, filename = here("figs/cleveland_plot_combined.pdf"), width = 14, height = 18)
```



